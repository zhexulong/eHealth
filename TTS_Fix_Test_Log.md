# TTS 修复测试记录

## 修复内容

### 1. 语速更改后第二次朗读无效问题
- **修复位置**: `src/hooks/useTTS.ts`
- **修复方案**: 新增 `resetTTSEngineInternal` 函数，在每次朗读前彻底重置TTS引擎状态
- **核心逻辑**: 停止播放 → 移除监听器 → 重新添加监听器 → 重设语速/语言参数

### 2. "朗读回复"按钮播放后迅速停止问题 - 进一步修复
- **修复位置**: 
  - `src/screens/Chat/index.tsx` - ChatScreen组件
  - `src/hooks/useTTS.ts` - useTTS Hook
- **问题根因**: 
  1. `isManualReading`状态重置时机存在竞争条件
  2. `useTTS.speak`方法中每次都调用`resetTTSEngineInternal`导致状态混乱
  3. 手动朗读与自动播报之间的状态同步问题
- **最新修复方案**: 
  1. **状态重置优化**: 在`isManualReading`重置时添加100ms延迟，防止状态竞争
  2. **朗读函数异步化**: `handleReadLatestReply`改为async函数，添加150ms延迟确保状态设置生效
  3. **speak方法优化**: 移除每次都重置引擎的逻辑，只在必要时（正在播放其他内容）才停止当前播放
  4. **引擎重置策略**: 只在`saveSettings`中检测到关键参数变更时才完全重置引擎

## 修复后的逻辑流程

### 用户点击"朗读回复"按钮时：
1. 设置 `isManualReading = true`
2. 调用 `speak(lastBotMessage)`
3. 自动播报的 useEffect 检测到 `isManualReading = true`，跳过自动播报
4. 朗读完成后，`isManualReading` 重置为 `false`

### 新消息到达时的自动播报：
1. 只有在 `isManualReading = false` 时才执行自动播报
2. 避免了与手动朗读的冲突

## 需要测试的场景

### 场景1：语速修改测试
1. 进入设置页面修改TTS语速
2. 返回Chat页面点击"朗读回复"
3. 验证是否能正确应用新的语速设置
4. 修改语速后再次点击朗读，验证第二次是否正常

### 场景2：朗读回复按钮测试
1. 在Chat页面发送消息获得AI回复
2. 点击"朗读回复"按钮
3. 验证朗读是否能完整播放，不会被中断
4. 测试在自动播报开启和关闭两种状态下的表现

### 场景3：自动播报与手动朗读冲突测试
1. 开启自动播报功能
2. 发送消息获得回复
3. 在自动播报开始前快速点击"朗读回复"按钮
4. 验证不会出现快速停止和重新开始的现象

### 场景4：状态竞争条件测试（新增）
1. 快速连续点击"朗读回复"按钮
2. 验证状态切换是否稳定，不会出现异常停止
3. 在朗读过程中切换到其他页面再返回，验证状态一致性

### 场景5：引擎重置逻辑测试（新增）
1. 修改语速设置后立即使用朗读功能
2. 验证引擎重置是否正确执行，新语速是否立即生效
3. 在不修改关键参数的情况下，验证引擎不会被不必要地重置

## 预期结果
- ✅ 语速修改后立即生效，不需要重启应用
- ✅ "朗读回复"按钮能完整播放内容，不会被中断
- ✅ 手动朗读与自动播报不会发生冲突
- ✅ TTS状态管理更加稳定和可靠
